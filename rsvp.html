<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSVP - Danville Poker Club</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <img src="https://www.danvillepokergroup.com/dpg.png" alt="Danville Poker Club Logo" class="logo" style="width: 150px;">

        <div id="eventDetails" class="card">
            <h2>Event Details</h2>
            <p>Date: <span id="eventDate"></span></p>
            <p>Host: <span id="eventHost"></span></p>
            <p>Location: <span id="eventLocation"></span></p>
        </div>

        <div class="card">
            <h2>Please RSVP</h2>
            <form id="rsvpForm">
                <label for="memberSelect">Select Your Name:</label>
                <select id="memberSelect" required>
                    <option value="">Choose your name</option>
                </select>

                <label for="confirmMemberSelect">Confirm Your Name:</label>
                <select id="confirmMemberSelect" required>
                    <option value="">Choose your name</option>
                </select>

                <label for="rsvpStatus">Your RSVP:</label>
                <select id="rsvpStatus" required>
                    <option value="attending">Attending</option>
                    <option value="not-attending">Not Attending</option>
                    <option value="maybe">Maybe</option>
                </select>

                <button type="submit">Submit RSVP</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { database } from './firebase-config.js';
        import { ref, get, set } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('token');

        if (!eventId) {
            alert('No event specified. Please use the correct RSVP link.');
        } else {
            // Fetch event details
            get(ref(database, `schedule/${eventId}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const eventData = snapshot.val();
                    document.getElementById('eventDate').textContent = eventData.date;
                    document.getElementById('eventHost').textContent = eventData.host;
                    document.getElementById('eventLocation').textContent = eventData.location;
                } else {
                    console.log("No event data available");
                }
            }).catch((error) => {
                console.error("Error fetching event details:", error);
            });

            // Populate member select dropdowns
            get(ref(database, 'members')).then((snapshot) => {
                if (snapshot.exists()) {
                    const members = Object.values(snapshot.val());
                    const selectElement = document.getElementById('memberSelect');
                    const confirmSelectElement = document.getElementById('confirmMemberSelect');
                    members.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.name;
                        option.textContent = member.name;
                        selectElement.appendChild(option.cloneNode(true));
                        confirmSelectElement.appendChild(option);
                    });
                } else {
                    console.log("No members data available");
                }
            }).catch((error) => {
                console.error("Error fetching members:", error);
            });

            // Handle form submission
            document.getElementById('rsvpForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('memberSelect').value;
                const confirmName = document.getElementById('confirmMemberSelect').value;
                const status = document.getElementById('rsvpStatus').value;
                
                if (name !== confirmName) {
                    alert('The selected names do not match. Please confirm your name.');
                    return;
                }

                if (name && status) {
                    set(ref(database, `rsvps/${eventId}/${encodeURIComponent(name)}`), {
                        name: name,
                        status: status
                    }).then(() => {
                        alert('RSVP submitted successfully!');
                        // Optionally, reset the form or redirect the user
                    }).catch((error) => {
                        console.error("Error submitting RSVP:", error);
                        alert('Error submitting RSVP. Please try again.');
                    });
                } else {
                    alert('Please select your name and RSVP status.');
                }
            });
        }
    </script>
</body>
</html>
