<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>RSVP Confirmation</h1>
        
        <div class="card">
            <div id="rsvpImage" class="rsvp-image-container"></div>
            <div id="addToCalendarContainer">
                <button id="addToCalendar" style="margin-bottom: 15px;">Add to Calendar</button>
            </div>
            <p>Change your RSVP as needed <a href="rsvp.html" id="rsvpLink">HERE</a> or from the email.</p>
        </div>

        <div class="card host-info">
            <h2>Event Details</h2>
            <div id="hostInfo">
                <p>Host: <span id="hostName"></span></p>
                <p>Time: 7:00 PM</p>
                <p>Location: <a id="addressLink" target="_blank"><span id="hostAddress"></span></a></p>
            </div>
        </div>

        <div class="card attendance-details">
            <h2>Event Attendance</h2>
            <div id="attendanceDetails">
                <div class="attendance-section">
                    <h3>Attending</h3>
                    <div id="attending"></div>
                </div>
                <div class="attendance-section">
                    <h3>Not Attending</h3>
                    <div id="notAttending"></div>
                </div>
                <div class="attendance-section">
                    <h3>Maybe</h3>
                    <div id="maybe"></div>
                </div>
                <div class="attendance-section">
                    <h3>No Response</h3>
                    <div id="noResponse"></div>
                </div>
                <div id="totalCount" class="total-section"></div>
            </div>
        </div>

        <div class="button-container" style="margin-top: 20px;">
            <button onclick="window.open('attendance.html', '_blank')" style="margin-right: 10px;">Attendance History</button>
            <button onclick="window.open('scheduled.html', '_blank')">Hosting Schedule</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules and config
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { firebaseConfig } from './firebase-config.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        function updateRsvpImage(status) {
            const rsvpImageContainer = document.getElementById('rsvpImage');
            let content = '';
            
            if (status === 'attending') {
                content = `
                    <h3>See you at the tables! ðŸŽ‰</h3>
                    <img src="images/poker-yes.gif" alt="Poker success" style="max-width: 300px;">
                `;
            } else if (status === 'not-attending') {
                content = `
                    <h3>Sorry you can't make it! ðŸ˜¢</h3>
                    <img src="images/poker-no.gif" alt="Maybe next time" style="max-width: 300px;">
                `;
            } else if (status === 'maybe') {
                content = `
                    <h3>Hope you can make it! ðŸ¤ž</h3>
                    <img src="images/poker-maybe.gif" alt="Maybe" style="max-width: 300px;">
                `;
            }
            
            rsvpImageContainer.innerHTML = content;
        }

        // Get event ID and member name from URL
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('token');
        const memberName = urlParams.get('member');

        // Update the RSVP link with the token
        if (eventId) {
            const rsvpLink = document.getElementById('rsvpLink');
            rsvpLink.href = `rsvp.html?token=${eventId}`;

            // Get event details
            const eventRef = ref(database, `schedule/${eventId}`);
            onValue(eventRef, (snapshot) => {
                const eventData = snapshot.val();
                if (eventData) {
                    // Add calendar button event listener
                    document.getElementById('addToCalendar').addEventListener('click', () => {
                        generateCalendarEvent(eventData);
                    });

                    // Update host information
                    document.getElementById('hostName').textContent = eventData.host;
                    document.getElementById('hostAddress').textContent = eventData.location;
                    const mapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(eventData.location)}`;
                    document.getElementById('addressLink').href = mapsLink;

                    // Process RSVPs
                    const rsvps = eventData.rsvps || {};
                    const attending = [];
                    const notAttending = [];
                    const maybe = [];
                    const noResponse = [];

                    Object.entries(rsvps).forEach(([name, status]) => {
                        switch(status) {
                            case 'attending':
                                attending.push(name);
                                break;
                            case 'not-attending':
                                notAttending.push(name);
                                break;
                            case 'maybe':
                                maybe.push(name);
                                break;
                            default:
                                noResponse.push(name);
                        }
                    });

                    // Update attendance lists
                    document.getElementById('attending').innerHTML = attending.length ? 
                        attending.join('<br>') : 'None';
                    document.getElementById('notAttending').innerHTML = notAttending.length ? 
                        notAttending.join('<br>') : 'None';
                    document.getElementById('maybe').innerHTML = maybe.length ? 
                        maybe.join('<br>') : 'None';
                    document.getElementById('noResponse').innerHTML = noResponse.length ? 
                        noResponse.join('<br>') : 'None';

                    // Update total count
                    document.getElementById('totalCount').innerHTML = `
                        Total Confirmed: ${attending.length} | 
                        Not Attending: ${notAttending.length} | 
                        Maybe: ${maybe.length} | 
                        No Response: ${noResponse.length}
                    `;

                    // Show RSVP image if member name is provided
                    if (memberName && eventData.rsvps[memberName]) {
                        updateRsvpImage(eventData.rsvps[memberName]);
                    }
                }
            });
        }

        function generateCalendarEvent(eventData) {
            const eventDate = new Date(eventData.date + 'T19:00:00'); // 7:00 PM
            const endDate = new Date(eventDate.getTime() + (4 * 60 * 60 * 1000)); // 4 hours duration

            const event = {
                title: 'Danville Poker Night',
                description: `Host: ${eventData.host}\nLocation: ${eventData.location}`,
                location: eventData.location,
                start: eventDate.toISOString(),
                end: endDate.toISOString()
            };

            const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(event.title)}&dates=${event.start.replace(/[-:]/g, '').replace('.000', '')}/${event.end.replace(/[-:]/g, '').replace('.000', '')}&details=${encodeURIComponent(event.description)}&location=${encodeURIComponent(event.location)}`;

            window.open(googleCalendarUrl, '_blank');
        }
    </script>

    <style>
        .attendance-section {
            margin-bottom: 20px;
        }
        .attendance-section h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .total-section {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            font-weight: bold;
        }
        #attending, #notAttending, #maybe, #noResponse {
            line-height: 1.6;
        }
        #addToCalendar {
            display: block;
            margin: 10px 0;
        }
        .rsvp-image-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .rsvp-image-container h3 {
            margin-bottom: 15px;
        }
        .rsvp-image-container img {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</body>
</html>
